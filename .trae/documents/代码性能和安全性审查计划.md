# 代码性能和安全性审查计划

## 审查概述
本文档详细分析 FactionGearModification 项目的代码性能和安全性问题，并提供改进建议。

---

## 一、性能问题

### 1.1 数据结构问题

**问题 1：频繁使用 `FirstOrDefault` 查找，无索引结构**
- **位置**：
  - `FactionGearCustomizerSettings.cs:53` - `GetOrCreateFactionData`
  - `FactionGearData.cs:30` - `GetOrCreateKindData`
  - `FactionGearData.cs:58` - `GetKindData`
- **问题描述**：使用 `List<T>` 存储数据，每次查找都需要 O(n) 时间复杂度
- **影响**：派系和兵种数量多时性能严重下降
- **建议**：添加 `Dictionary<string, T>` 作为索引结构

**问题 2：重复计算缓存**
- **位置**：`FactionGearEditor.cs:783-900` - `GetFilteredAndSortedItems`
- **问题描述**：虽然有缓存，但多个筛选条件同时变化时仍会重复计算
- **建议**：使用更多粒度的缓存，避免全量重新计算

---

### 1.2 UI 性能问题

**问题 3：UI 绘制中频繁访问 `DefDatabase`**
- **位置**：`FactionGearEditor.cs` 和 `PresetManagerWindow.cs`
- **问题描述**：在 `Draw` 循环中频繁调用 `DefDatabase<>.GetNamedSilentFail`
- **建议**：在选择派系/兵种时预先缓存所需的 Def 引用

**问题 4：频繁调用 `Settings.Write()`**
- **位置**：
  - `FactionGearEditor.cs:699` - 调整权重滑块时立即保存
  - `FactionGearEditor.cs:709` - 删除装备项时立即保存
- **问题描述**：每次微小操作都触发文件 IO，造成性能瓶颈
- **建议**：使用延迟保存（Debounce）或批量保存策略

---

### 1.3 算法效率问题

**问题 5：`LoadKindDefGear` 中重复查询 `DefDatabase`**
- **位置**：`FactionGearManager.cs:107, 127`
- **问题描述**：
  ```csharp
  var weapons = DefDatabase<ThingDef>.AllDefs.Where(...).ToList();
  var apparels = DefDatabase<ThingDef>.AllDefs.Where(...).ToList();
  ```
  每次加载兵种装备都全量遍历 `DefDatabase`
- **建议**：使用已有的缓存数据（`cachedAllWeapons` 等）

**问题 6：`CalculateRequiredMods` 中重复访问 `ThingDef`**
- **位置**：`FactionGearPreset.cs:31-50`
- **问题描述**：
  ```csharp
  var def = gear.ThingDef; // 每次都从 DefDatabase 重新获取
  ```
- **建议**：在保存预设时缓存 mod 来源信息

---

## 二、安全性问题

### 2.1 异常处理问题

**问题 7：空异常风险 - 缺少 null 检查**
- **位置**：`Dialog_InfoCard.cs:59`
  ```csharp
  lines.Add($"Damage: {verb.defaultProjectile.projectile.GetDamageAmount(null):F1}");
  ```
- **问题描述**：`verb.defaultProjectile.projectile` 可能为 null
- **建议**：添加完整的 null 检查链

**问题 8：空异常风险 - `apparel` 属性访问**
- **位置**：`FactionGearManager.cs:127, 130`
  ```csharp
  var apparels = DefDatabase<ThingDef>.AllDefs.Where(t => t.IsApparel && t.apparel.tags != null ...)
  ```
- **问题描述**：`t.apparel` 可能为 null（虽然 `IsApparel` 应该保证不为 null，但最好显式检查）
- **建议**：添加 `t.apparel != null` 检查

---

### 2.2 文件 IO 安全问题

**问题 9：临时文件未清理**
- **位置**：`PresetIOManager.cs:13, 33`
  ```csharp
  string path = Path.Combine(GenFilePaths.ConfigFolderPath, "TempPresetExport.xml");
  ```
- **问题描述**：导出/导入后临时文件保留在磁盘上
- **建议**：使用 `File.Delete` 在操作完成后清理临时文件，或使用 `Path.GetTempFileName()`

**问题 10：Base64 解码无长度限制**
- **位置**：`PresetIOManager.cs:36`
  ```csharp
  string xml = System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(base64));
  ```
- **问题描述**：恶意输入可能导致内存溢出
- **建议**：在解码前检查 Base64 字符串长度，设置合理上限

---

### 2.3 数据安全问题

**问题 11：深拷贝不完整导致内存共享**
- **位置**：多处深拷贝代码
- **问题描述**：虽然代码中有深拷贝，但部分地方可能仍有引用共享风险
- **建议**：审查所有数据传递路径，确保没有意外的引用共享

**问题 12：预设导入无验证**
- **位置**：`PresetIOManager.cs:31-50`
- **问题描述**：导入的 XML 数据未进行完整性验证
- **建议**：添加数据验证，检查：
  - 必填字段是否存在
  - 数据类型是否正确
  - 引用的 Def 是否存在

---

## 三、代码质量问题

### 3.1 重复代码

**问题 13：深拷贝逻辑重复**
- **位置**：
  - `KindGearData.cs:52-63` - `DeepCopy()`
  - `KindGearData.cs:65-73` - `CopyFrom()`
  - `FactionGearPreset.cs:62-74` - 内联深拷贝
  - `PresetManagerWindow.cs:230-238` - 内联深拷贝
- **建议**：统一深拷贝接口，减少重复代码

**问题 14：武器生成逻辑重复**
- **位置**：`GearApplier.cs:44-85`
- **问题描述**：远程武器和近战武器的生成逻辑几乎完全相同
- **建议**：提取公共方法

---

### 3.2 魔法数字

**问题 15：硬编码的阈值**
- **位置**：
  - `FactionGearManager.cs:42, 52` - `0.4f` 护甲阈值
  - `FactionGearEditor.cs:964` - `100f` 最大射程
  - `FactionGearEditor.cs:969` - `100f` 最大伤害
  - `FactionGearEditor.cs:973` - `10000f` 最大市场价值
- **建议**：定义为常量或可配置参数

---

## 四、改进优先级

### 高优先级（立即修复）
1. **问题 10**：Base64 解码无长度限制 - 安全风险
2. **问题 7**：`Dialog_InfoCard` 空异常 - 可能导致崩溃
3. **问题 4**：频繁调用 `Settings.Write()` - 性能瓶颈

### 中优先级（尽快修复）
4. **问题 1**：添加字典索引结构 - 性能优化
5. **问题 5**：使用缓存替代重复查询 - 性能优化
6. **问题 9**：清理临时文件 - 安全和整洁

### 低优先级（逐步优化）
7. **问题 13**：减少重复代码 - 代码质量
8. **问题 15**：消除魔法数字 - 代码可维护性
9. **问题 2**：优化缓存策略 - 性能优化

---

## 五、改进实施计划

### 阶段 1：安全修复（高优先级）
- [ ] 修复 Base64 解码长度限制
- [ ] 添加完整的 null 检查链
- [ ] 清理临时文件

### 阶段 2：性能优化（高/中优先级）
- [ ] 添加字典索引结构
- [ ] 实现延迟保存机制
- [ ] 使用已有缓存替代重复查询

### 阶段 3：代码质量提升（低优先级）
- [ ] 统一深拷贝接口
- [ ] 消除魔法数字
- [ ] 优化缓存策略

---

## 六、测试建议

1. **性能测试**：
   - 在大量派系/兵种的环境下测试
   - 测量 UI 响应时间
   - 测量文件 IO 频率

2. **安全测试**：
   - 测试恶意 Base64 输入
   - 测试损坏的预设 XML
   - 测试 null/异常边界情况

3. **功能测试**：
   - 确保所有现有功能正常工作
   - 测试预设导入/导出
   - 测试装备应用

---

*审查完成日期：2026-02-20*
