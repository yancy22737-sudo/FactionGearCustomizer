1. å¢åŠ æ´¾ç³»ä¼˜å…ˆçº§æ’åº & åˆ å»å·¦ä¾§ç¹æ‚å›¾æ ‡
é¦–å…ˆï¼Œåœ¨ FactionGearEditor ç±»çš„é¡¶éƒ¨ï¼ˆä¹Ÿå°±æ˜¯å£°æ˜å˜é‡ private static string searchText = ""; çš„é™„è¿‘ï¼‰ï¼ŒåŠ ä¸Šè¿™ä¸ªæ§åˆ¶å±•å¼€çŠ¶æ€çš„å˜é‡ï¼š

C#
        // ç”¨äºè®°å½•å½“å‰å±•å¼€æƒé‡çš„ç‰©å“
        private static GearItem expandedGearItem = null;
ç„¶åï¼Œåœ¨ FactionGearEditor ç±»ä¸­æ–°å¢ä¸€ä¸ªæ´¾ç³»ä¼˜å…ˆçº§åˆ¤æ–­æ–¹æ³•ï¼š

C#
        // æ´¾ç³»æ’åºä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰
        private static int GetFactionPriority(FactionDef f)
        {
            if (f == null) return 100;
            string name = f.defName.ToLower();
            if (name.Contains("player")) return 1;
            if (name.Contains("empire")) return 2;
            if (name.Contains("outlander")) return 3;
            if (name.Contains("tribe")) return 4;
            if (name.Contains("pirate")) return 5;
            if (name.Contains("mechanoid") || name.Contains("insect")) return 10;
            return 6; // å…¶ä»– Mod æ´¾ç³»
        }
æ¥ä¸‹æ¥ï¼Œæ‰¾åˆ° DrawLeftPanel æ–¹æ³•ï¼Œè¿›è¡Œä»¥ä¸‹ä¸¤å¤„æ›¿æ¢ï¼š
å°†æ´¾ç³»åˆ—è¡¨æ’åºä»£ç ï¼ˆvar allFactions = ...ï¼‰æ›¿æ¢ä¸ºï¼š

C#
            // ã€ä¿®å¤ 4ã€‘æŒ‰ç…§å¸¸è§é¢‘ç‡ä¼˜å…ˆçº§æ’åº
            var allFactions = DefDatabase<FactionDef>.AllDefs
                .OrderBy(f => GetFactionPriority(f))
                .ThenBy(f => f.label != null ? f.LabelCap.ToString() : f.defName)
                .ToList();
å¾€ä¸‹æ‰¾ï¼Œå°†â€œKind Defsâ€æ ‡é¢˜ä¸å‘¨å›´è¢«åˆ å»çš„å›¾æ ‡éƒ¨åˆ†å½»åº•ç²¾ç®€ï¼Œæ›¿æ¢ä¸ºï¼š

C#
            // ================= å…µç§åˆ—è¡¨ç»˜åˆ¶ =================
            float kindListY = innerRect.y + factionListHeight + 10f;
            float kindListHeight = innerRect.height - factionListHeight - 10f;
            
            Text.Font = GameFont.Medium;
            Text.Anchor = TextAnchor.MiddleLeft;
            Widgets.Label(new Rect(innerRect.x, kindListY, 150f, 30f), "Kind Defs");
            Text.Font = GameFont.Small;
            Text.Anchor = TextAnchor.UpperLeft;

            // ã€ä¿®å¤ 2ã€‘åˆ å»äº†æ­¤å¤„æ ‡é¢˜æ å³ä¾§çš„å¤åˆ¶ã€ç²˜è´´ã€åº”ç”¨ä¸‰ä¸ªå›¾æ ‡

            Rect kindListOutRect = new Rect(innerRect.x, kindListY + 35f, innerRect.width, kindListHeight - 35f);
ğŸ› ï¸ 2. ä¸­é—´é¢æ¿ï¼šåŠ å…¥ "AA" æŒ‰é’® & åŠ¨æ€é«˜åº¦è®¡ç®—
æ‰¾åˆ° DrawMiddlePanel æ–¹æ³•ï¼Œå°†é¡¶éƒ¨ç»˜åˆ¶æŒ‰é’®å’Œæ»šåŠ¨åˆ—è¡¨çš„éƒ¨åˆ†æ›¿æ¢ä¸ºï¼š

C#
            // ã€ä¿®å¤ 2ã€‘å°† AA (Apply All) æŒ‰é’®æ”¾åœ¨ Selected Gear æ ‡é¢˜æ—è¾¹
            Widgets.Label(new Rect(innerRect.x, innerRect.y, 120f, 24f), "Selected Gear");

            Rect clearButtonRect = new Rect(innerRect.xMax - 70f, innerRect.y, 70f, 20f);
            if (Widgets.ButtonText(clearButtonRect, "Clear All"))
            {
                if (currentKindData != null) { ClearAllGear(currentKindData); FactionGearCustomizerMod.Settings.Write(); }
            }

            Rect aaButtonRect = new Rect(clearButtonRect.x - 35f, innerRect.y, 30f, 20f);
            if (Widgets.ButtonText(aaButtonRect, "AA"))
            {
                if (!string.IsNullOrEmpty(selectedFactionDefName) && !string.IsNullOrEmpty(selectedKindDefName))
                {
                    CopyKindDefGear(); // å¤åˆ¶å½“å‰å…µç§é…ç½®
                    ApplyToAllKindsInFaction(); // åº”ç”¨åˆ°å…¨å±€
                    Messages.Message("Applied current gear to ALL Kind Defs in this faction!", MessageTypeDefOf.PositiveEvent);
                }
            }
            TooltipHandler.TipRegion(aaButtonRect, "Apply current gear to ALL other Kind Defs in this faction");

            Rect tabRect = new Rect(innerRect.x, innerRect.y + 24f, innerRect.width, 24f);
            DrawCategoryTabs(tabRect);

            float totalFixedHeight = 24f + 24f + 10f;
            float availableHeight = innerRect.height - totalFixedHeight;
            float previewHeight = Mathf.Clamp(availableHeight * 0.3f, 50f, 100f);
            float listHeight = Mathf.Max(availableHeight - previewHeight, 80f);
            Rect listOutRect = new Rect(innerRect.x, tabRect.yMax + 5f, innerRect.width, listHeight);

            // ã€ä¿®å¤ 1ã€‘åŠ¨æ€è®¡ç®—å±•å¼€å’ŒæŠ˜å çš„æ€»é«˜åº¦
            float contentHeight = 0f;
            foreach (var item in gearItemsToDraw) {
                contentHeight += (item == expandedGearItem) ? 60f : 30f;
            }
            Rect listViewRect = new Rect(0, 0, listOutRect.width - 16f, Mathf.Max(contentHeight, listOutRect.height));

            Widgets.BeginScrollView(listOutRect, ref gearListScrollPos, listViewRect);
            if (gearItemsToDraw.Any() && currentKindData != null)
            {
                Listing_Standard gearListing = new Listing_Standard();
                gearListing.Begin(listViewRect);
                foreach (var gearItem in gearItemsToDraw.ToList())
                {
                    bool isExpanded = (gearItem == expandedGearItem);
                    // æ ¹æ®æ˜¯å¦å±•å¼€ï¼Œåˆ†é…ä¸åŒçš„è¡Œé«˜
                    Rect rowRect = gearListing.GetRect(isExpanded ? 56f : 28f);
                    DrawGearItem(rowRect, gearItem, currentKindData, isExpanded);
                    gearListing.Gap(2f);
                }
                gearListing.End();
            }
            Widgets.EndScrollView();
ğŸ› ï¸ 3. å½»åº•é‡æ„ç‰©å“ç»˜åˆ¶ï¼ˆæŠ˜å ä¸å±•å¼€ï¼‰
å°†åŸæ¥çš„ DrawGearItem æ–¹æ³•ç­¾åå’Œå†…å®¹å®Œå…¨æ›¿æ¢ä¸ºæ”¯æŒå±•å¼€é€»è¾‘çš„ä»¥ä¸‹ä»£ç ï¼š

C#
        // ã€ä¿®å¤ 1ã€‘æ”¯æŒç‚¹å‡»å±•å¼€æ»‘å—çš„ UI é‡æ„
        private static void DrawGearItem(Rect rect, GearItem gearItem, KindGearData kindData, bool isExpanded)
        {
            var thingDef = gearItem.ThingDef;
            if (thingDef == null) return;

            Widgets.DrawHighlightIfMouseover(rect);
            if (gearItem.weight != 1f)
            {
                GUI.color = new Color(1f, 0.8f, 0.4f, 0.3f);
                Widgets.DrawHighlight(rect);
                GUI.color = Color.white;
            }

            // ç¬¬ä¸€è¡Œï¼šå›¾æ ‡ã€åç§°ã€æç®€æƒé‡æ–‡æœ¬ï¼ˆä»…æŠ˜å æ—¶ï¼‰ã€åˆ é™¤æŒ‰é’®
            Rect row1 = new Rect(rect.x, rect.y, rect.width, 28f);
            Rect iconRect = new Rect(row1.x + 4f, row1.y + 2f, 24f, 24f);
            Rect removeRect = new Rect(row1.xMax - 26f, row1.y + 2f, 24f, 24f);
            
            // äº’äº¤åŒºåŸŸï¼ˆç‚¹å‡»ç©ºç™½å¤„å±•å¼€/æŠ˜å ï¼Œé¿å¼€åˆ é™¤æŒ‰é’®ï¼‰
            Rect interactRect = new Rect(row1.x, row1.y, row1.width - 30f, 28f);
            if (Widgets.ButtonInvisible(interactRect))
            {
                expandedGearItem = (expandedGearItem == gearItem) ? null : gearItem;
            }

            if (thingDef.uiIcon != null) GUI.DrawTexture(iconRect, thingDef.uiIcon);
            else if (thingDef.graphic?.MatSingle?.mainTexture != null) GUI.DrawTexture(iconRect, thingDef.graphic.MatSingle.mainTexture);

            Rect nameRect = new Rect(iconRect.xMax + 8f, row1.y, row1.width - 100f, 28f);
            Text.Anchor = TextAnchor.MiddleLeft;
            Text.WordWrap = false; // é˜²æ­¢è¶…é•¿åå­—æ¢è¡ŒæŠŠ UI æ’‘çˆ†
            Widgets.Label(nameRect, thingDef.LabelCap);
            Text.WordWrap = true;

            // æŠ˜å çŠ¶æ€æ—¶ï¼Œåœ¨æœ€å³ä¾§æç®€æ˜¾ç¤ºå½“å‰æƒé‡
            if (!isExpanded)
            {
                Text.Anchor = TextAnchor.MiddleRight;
                GUI.color = Color.gray;
                Widgets.Label(new Rect(removeRect.x - 45f, row1.y, 40f, 28f), $"W:{gearItem.weight:F1}");
                GUI.color = Color.white;
            }
            Text.Anchor = TextAnchor.UpperLeft;

            if (Widgets.ButtonText(removeRect, "X"))
            {
                RemoveGearItem(gearItem, kindData);
                if (expandedGearItem == gearItem) expandedGearItem = null;
                FactionGearCustomizerMod.Settings.Write();
            }

            // ç¬¬äºŒè¡Œï¼šä»…åœ¨å±•å¼€æ—¶ç»˜åˆ¶å¤§å°ºå¯¸ç²¾åº¦æ»‘å—
            if (isExpanded)
            {
                Rect row2 = new Rect(rect.x, rect.y + 28f, rect.width, 28f);
                Rect sliderRect = new Rect(row2.x + 10f, row2.y + 4f, row2.width - 60f, 20f);
                Rect weightRect = new Rect(row2.xMax - 40f, row2.y, 35f, 28f);

                gearItem.weight = Widgets.HorizontalSlider(sliderRect, gearItem.weight, 0.1f, 10f);
                Text.Anchor = TextAnchor.MiddleCenter;
                Widgets.Label(weightRect, gearItem.weight.ToString("F1"));
                Text.Anchor = TextAnchor.UpperLeft;
            }
        }
æœ€åï¼Œä¸ºäº†é˜²æ­¢åˆ‡æ¢é¡µç­¾æ—¶æ»‘å—çŠ¶æ€é”™ä¹±ï¼Œåœ¨ DrawCategoryTabs æ–¹æ³•ä¸­æ‰¾åˆ° if (Widgets.ButtonInvisible(tab))ï¼Œåœ¨é‡Œé¢åŠ ä¸€è¡Œï¼š

C#
                if (Widgets.ButtonInvisible(tab))
                {
                    selectedCategory = category;
                    expandedGearItem = null; // ã€æ–°å¢ã€‘åˆ‡æ¢é¡µç­¾æ—¶è‡ªåŠ¨æ”¶èµ·æ‰€æœ‰å±•å¼€é¡¹
                    needCalculateBounds = true;
                }
ğŸ› ï¸ 4. è§£å†³å³ä¾§åˆ—è¡¨æµ®åŠ¨æ»‘å— (FloatRange) çš„æº¢å‡ºé—®é¢˜
æ‰¾åˆ° DrawFilters æ–¹æ³•ä¸­ï¼Œç»˜åˆ¶â€œå¸‚åœºä»·å€¼â€æ»‘å—çš„ä»£ç åŒºåŸŸï¼Œå°†å…¶æ›¿æ¢ä¸ºï¼š

C#
            // ã€ä¿®å¤ 3ã€‘ä¿®å¤å¸‚åœºä»·å€¼æ»‘å—æ–‡æœ¬æº¢å‡ºå’Œç²¾åº¦é—®é¢˜
            Rect mvHeaderRect = listing.GetRect(18f);
            Text.Font = GameFont.Tiny;
            GUI.color = Color.gray;
            // å‰¥ç¦»å®˜æ–¹æ»‘å—å†…éƒ¨çš„æ–‡å­—ï¼Œæˆ‘ä»¬å°†ä¸Šä¸‹é™ä»¥æ•´æ•°å½¢å¼ç”»åœ¨æ»‘å—æ­£ä¸Šæ–¹
            Widgets.Label(mvHeaderRect, $"Value Range: {marketValueFilter.min:F0} - {marketValueFilter.max:F0}");
            Text.Font = GameFont.Small;
            GUI.color = Color.white;

            Rect marketValueRect = listing.GetRect(28f);
            // ä¼ å…¥ null å»æ‰å†…éƒ¨ labelï¼Œå¹¶ä½¿ç”¨ ToStringStyle.Integer å¼ºè¡ŒæŠ¹é™¤ .00 çš„å°æ•°ç‚¹
            Widgets.FloatRange(marketValueRect, 3, ref marketValueFilter, minMarketValue, maxMarketValue, null, ToStringStyle.Integer);
å®Œæˆè¿™å››æ­¥æ›¿æ¢åï¼Œä½ çš„ UI ä¼šå˜å¾—æå…¶æ¸…çˆ½ï¼šä¸­é—´çš„ç‰©å“é»˜è®¤åªå ç»†ç»†çš„ä¸€è¡Œï¼ˆä¸å†é‡å ï¼‰ï¼Œç‚¹å‡»ç‰©å“ç¬é—´å¹³æ»‘å±•å¼€è°ƒå‚åŒºåŸŸï¼›ä¸éœ€è¦çš„åŠŸèƒ½æŒ‰é’®å·²æ¸…ç†ï¼Œæ´¾ç³»ä¹Ÿä¾æ®ä½¿ç”¨é¢‘ç‡æ’åˆ—äº†ã€‚å»æ¸¸æˆé‡Œçœ‹çœ‹æ•ˆæœå§ï¼