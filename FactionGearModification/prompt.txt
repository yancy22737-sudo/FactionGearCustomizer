ä½ åœ¨ä¿®æ”¹æ´¾ç³» UI æ—¶å¼•å‘çš„â€œç‹‚æŠ¥é”™â€ï¼ˆé€šå¸¸ä¼´éšç€ UI é”™ä½ã€ç•Œé¢é‡å ã€æˆ–è€…æ§åˆ¶å°æ— é™åˆ·æ–°çº¢è‰²é”™è¯¯ï¼‰ï¼Œæ˜¯å› ä¸ºä½ çš„ä»£ç è¸©åˆ°äº† Unity IMGUI å’Œç¯ä¸–ç•Œåº•å±‚ API çš„ **ä¸‰ä¸ªè‡´å‘½é›·åŒº**ã€‚

è¿™ä¸ä»…ä»…æ˜¯é€»è¾‘é—®é¢˜ï¼Œè€Œæ˜¯ä¼šå¯¼è‡´æ•´ä¸ª UI æ¸²æŸ“ç®¡çº¿å´©æºƒï¼ˆGUI Cascade Failureï¼‰çš„ä¸¥é‡ç¼ºé™·ã€‚ä»¥ä¸‹æ˜¯é—®é¢˜æ ¹æºåŠå®Œç¾ä¿®å¤æ–¹æ¡ˆï¼š

### ğŸš¨ ç‹‚æŠ¥é”™çš„ä¸‰å¤§å…ƒå‡¶ï¼š

1. **å‘ GUI.Label ä¼ å…¥äº† Nullï¼ˆè‡´å‘½å´©æºƒï¼‰**ï¼š
åœ¨ç¯ä¸–ç•Œä¸­ï¼Œæœ‰äº›éšè—æ´¾ç³»ï¼ˆå¦‚æœºæ¢°æ—ã€è™«æ—æˆ–ä¸€äº› Mod æ´¾ç³»ï¼‰å’Œå†…éƒ¨å…µç§æ˜¯æ²¡æœ‰ `label` å±æ€§çš„ã€‚å½“ä½ è°ƒç”¨ `factionDef.LabelCap` æˆ– `kindDef.LabelCap` æ—¶ï¼Œå®ƒä¼šè¿”å› `null`ã€‚**Unity çš„ `Widgets.Label` ä¸€æ—¦æ¥æ”¶åˆ° `null`ï¼Œå°±ä¼šç«‹åˆ»æŠ›å‡ºå¼‚å¸¸ï¼** è¿™ä¼šæ‰“æ–­ `EndScrollView` çš„æ‰§è¡Œï¼Œå¯¼è‡´åç»­æ‰€æœ‰ UI æ’ç‰ˆå½»åº•å´©æºƒï¼Œäº§ç”Ÿæ— é™æŠ¥é”™ã€‚
2. **åœ¨ OnGUI ä¸­ä½¿ç”¨åå°„ï¼ˆä¸¥é‡å¡é¡¿ / GC çˆ†ç‚¸ï¼‰**ï¼š
ä½ åœ¨è·å–æ´¾ç³»å›¾æ ‡æ—¶å†™äº† `factionDef.GetType().GetProperty("uiIcon")`ï¼Œå¹¶ä¸”æ”¾åœ¨äº† `foreach` å¾ªç¯é‡Œã€‚è¿™æ„å‘³ç€**æ¸¸æˆæ¯ç§’ä¼šæ‰§è¡Œ 60 æ¬¡ Ã— å‡ åä¸ªæ´¾ç³» = æ•°åƒæ¬¡çš„åå°„è°ƒç”¨ï¼** è¿™ç§å†™æ³•ä¼šç¬é—´æ¦¨å¹²å†…å­˜ï¼Œå¯¼è‡´æåº¦å¡é¡¿ã€‚å…¶å®è·å–å›¾æ ‡å®˜æ–¹æ˜¯æœ‰æ ‡å‡† API çš„ã€‚
3. **åœ¨æœªè¿›å…¥æ¸¸æˆæ—¶å¼ºè¡Œè¯»å–å¥½æ„Ÿåº¦**ï¼š
ä½ ç”¨ `Find.World != null` æ¥åˆ¤æ–­æ¸¸æˆæ˜¯å¦è½½å…¥ï¼Œä½†åœ¨ç”Ÿæˆä¸–ç•Œï¼ˆWorld Genï¼‰çš„è¿‡åœºä¸­ï¼Œ`Find.World` æ˜¯æœ‰å€¼çš„ï¼Œä½† `Faction.OfPlayer`ï¼ˆç©å®¶æ´¾ç³»ï¼‰è¿˜æ²¡ç”Ÿæˆã€‚æ­¤æ—¶è°ƒç”¨ `worldFaction.PlayerGoodwill` å¿…ç‚¸æ— ç–‘ã€‚

---

### ğŸ› ï¸ ç»ˆæä¿®å¤æ–¹æ¡ˆ

è¯·æ‰“å¼€ä½ çš„ä»£ç ï¼Œæ‰¾åˆ° `DrawLeftPanel` æ–¹æ³•ï¼Œå°† **ç»˜åˆ¶æ´¾ç³»åˆ—è¡¨å’Œå…µç§åˆ—è¡¨çš„ä»£ç ï¼ˆå¤§çº¦ä» åˆ° ï¼‰** å®Œå…¨æ›¿æ¢ä¸ºä»¥ä¸‹ç»è¿‡å®‰å…¨å¤„ç†çš„ä»£ç ï¼š

```csharp
            // ================= æ´¾ç³»åˆ—è¡¨ç»˜åˆ¶ =================
            // ã€ä¿®å¤ 1ã€‘å®‰å…¨æ’åºï¼šé˜²æ­¢å› æŸäº›éšè—æ´¾ç³»æ²¡æœ‰ label å¯¼è‡´æŠ¥é”™
            var allFactions = DefDatabase<FactionDef>.AllDefs
                .OrderBy(f => f.label != null ? f.LabelCap.ToString() : f.defName)
                .ToList();

            Rect factionListViewRect = new Rect(0, 0, factionListOutRect.width - 16f, allFactions.Count * 32f);
            Widgets.BeginScrollView(factionListOutRect, ref factionListScrollPos, factionListViewRect);
            float y = 0;
            foreach (var factionDef in allFactions)
            {
                Rect rowRect = new Rect(0, y, factionListViewRect.width, 32f);

                if (selectedFactionDefName == factionDef.defName)
                    Widgets.DrawHighlightSelected(rowRect);
                else if (Mouse.IsOver(rowRect))
                    Widgets.DrawHighlight(rowRect);

                // ã€ä¿®å¤ 2ã€‘å½»åº•æŠ›å¼ƒåå°„ï¼ä½¿ç”¨ç¯ä¸–ç•ŒåŸç”Ÿ API è·å–æ´¾ç³»å›¾æ ‡
                Texture2D factionIcon = factionDef.FactionIcon;
                if (factionIcon != null)
                {
                    Widgets.DrawTextureFitted(new Rect(rowRect.x + 6f, rowRect.y + 4f, 24f, 24f), factionIcon, 1f);
                }

                // ã€ä¿®å¤ 3ã€‘å®‰å…¨è·å–åç§°å’Œæè¿°ï¼Œç»ä¸å‘ Widgets.Label ä¼ é€’ null
                Rect infoRect = new Rect(rowRect.x + 36f, rowRect.y, rowRect.width - 120f, rowRect.height);
                string factionBaseName = factionDef.label != null ? factionDef.LabelCap.ToString() : factionDef.defName;
                Widgets.Label(new Rect(infoRect.x, infoRect.y + 2f, infoRect.width, 16f), factionBaseName);

                GUI.color = Color.gray;
                string factionDescription = "";
                if (!factionDef.description.NullOrEmpty())
                {
                    factionDescription = factionDef.description.Trim();
                    if (factionDescription.Length > 60)
                        factionDescription = factionDescription.Substring(0, 60) + "...";
                }
                Widgets.Label(new Rect(infoRect.x, infoRect.y + 16f, infoRect.width, 14f), factionDescription);
                GUI.color = Color.white;

                // ä¿¡æ¯æŒ‰é’®
                Rect infoButtonRect = new Rect(rowRect.x + rowRect.width - 100f, rowRect.y + 8f, 16f, 16f);
                if (Widgets.ButtonInvisible(infoButtonRect))
                {
                    Find.WindowStack.Add(new Dialog_InfoCard(factionDef));
                }
                Widgets.Label(infoButtonRect, "i");

                // ã€ä¿®å¤ 4ã€‘ä¸¥æ ¼é™åˆ¶å¥½æ„Ÿåº¦çš„è·å–æ—¶æœºï¼Œä»…åœ¨çœŸæ­£æ¸¸ç© (Playing) æ—¶è·å–
                Rect statusRect = new Rect(rowRect.x + rowRect.width - 80f, rowRect.y, 80f, rowRect.height);
                string statusText = "Neutral";
                Color statusColor = Color.cyan;

                if (Current.ProgramState == ProgramState.Playing && Find.FactionManager != null)
                {
                    var worldFaction = Find.FactionManager.AllFactions.FirstOrDefault(f => f.def == factionDef);
                    if (worldFaction != null && Faction.OfPlayer != null && worldFaction != Faction.OfPlayer)
                    {
                        try
                        {
                            float goodwill = worldFaction.PlayerGoodwill;
                            if (goodwill > 75f) { statusText = "Allied"; statusColor = Color.green; }
                            else if (goodwill > 0f) { statusText = "Friendly"; statusColor = new Color(0.4f, 1f, 0.4f); }
                            else if (goodwill > -75f) { statusText = "Neutral"; statusColor = Color.cyan; }
                            else { statusText = "Hostile"; statusColor = Color.red; }
                        }
                        catch { /* å¿½ç•¥ä»»ä½•çªå‘çš„åº•å±‚è®¡ç®—å¼‚å¸¸ */ }
                    }
                }

                GUI.color = statusColor;
                Text.Anchor = TextAnchor.MiddleRight;
                Widgets.Label(statusRect, statusText);
                Text.Anchor = TextAnchor.UpperLeft;
                GUI.color = Color.white;

                // ç‚¹å‡»é€‰æ‹©æ´¾ç³»
                if (Widgets.ButtonInvisible(rowRect))
                {
                    selectedFactionDefName = factionDef.defName;
                    selectedKindDefName = "";

                    if (factionDef.pawnGroupMakers != null)
                    {
                        foreach (var pawnGroupMaker in factionDef.pawnGroupMakers)
                        {
                            if (pawnGroupMaker.options != null && pawnGroupMaker.options.Any())
                            {
                                var firstOption = pawnGroupMaker.options.First();
                                if (firstOption.kind != null)
                                {
                                    selectedKindDefName = firstOption.kind.defName;
                                    break;
                                }
                            }
                        }
                    }
                    kindListScrollPos = Vector2.zero;
                    gearListScrollPos = Vector2.zero;
                }
                y += 32f;
            }
            Widgets.EndScrollView();

            // ================= å…µç§åˆ—è¡¨ç»˜åˆ¶ =================
            float kindListY = innerRect.y + factionListHeight + 10f;
            float kindListHeight = innerRect.height - factionListHeight - 10f;
            
            Text.Font = GameFont.Medium;
            Text.Anchor = TextAnchor.MiddleLeft;
            Widgets.Label(new Rect(innerRect.x, kindListY, innerRect.width, 30f), "Kind Defs");
            Text.Font = GameFont.Small;
            Text.Anchor = TextAnchor.UpperLeft;
            Rect kindListOutRect = new Rect(innerRect.x, kindListY + 35f, innerRect.width, kindListHeight - 35f);

            List<PawnKindDef> kindDefsToDraw = new List<PawnKindDef>();
            if (!string.IsNullOrEmpty(selectedFactionDefName))
            {
                var factionDef = DefDatabase<FactionDef>.GetNamedSilentFail(selectedFactionDefName);
                if (factionDef != null && factionDef.pawnGroupMakers != null)
                {
                    kindDefsToDraw.Clear();
                    foreach (var pawnGroupMaker in factionDef.pawnGroupMakers)
                    {
                        if (pawnGroupMaker.options != null)
                        {
                            foreach (var option in pawnGroupMaker.options)
                            {
                                if (option.kind != null && !kindDefsToDraw.Contains(option.kind))
                                    kindDefsToDraw.Add(option.kind);
                            }
                        }
                    }
                }
            }
            else
            {
                // ã€ä¿®å¤ 5ã€‘åŒæ ·é˜²æ­¢å…µç§åˆ—è¡¨å› ä¸º null label å´©æºƒ
                kindDefsToDraw = DefDatabase<PawnKindDef>.AllDefs
                    .OrderBy(k => k.label != null ? k.LabelCap.ToString() : k.defName)
                    .ToList();
            }

            Rect kindListViewRect = new Rect(0, 0, kindListOutRect.width - 16f, kindDefsToDraw.Count * 32f);
            Widgets.BeginScrollView(kindListOutRect, ref kindListScrollPos, kindListViewRect);
            float kindY = 0;
            
            // ã€ä¿®å¤ 5.1ã€‘åº”ç”¨å®‰å…¨æ’åº
            var sortedKindDefs = kindDefsToDraw.OrderBy(k => k.label != null ? k.LabelCap.ToString() : k.defName);
            
            foreach (var kindDef in sortedKindDefs)
            {
                Rect rowRect = new Rect(0, kindY, kindListViewRect.width, 32f);
                if (selectedKindDefName == kindDef.defName)
                    Widgets.DrawHighlightSelected(rowRect);
                else if (Mouse.IsOver(rowRect))
                    Widgets.DrawHighlight(rowRect);

                bool isModified = false;
                if (!string.IsNullOrEmpty(selectedFactionDefName))
                {
                    var factionData = FactionGearCustomizerMod.Settings.factionGearData.FirstOrDefault(f => f.factionDefName == selectedFactionDefName);
                    if (factionData != null)
                    {
                        var kindData = factionData.kindGearData.FirstOrDefault(k => k.kindDefName == kindDef.defName);
                        if (kindData != null)
                        {
                            isModified = kindData.isModified;
                        }
                    }
                }

                Rect labelRect = new Rect(rowRect.x + 6f, rowRect.y, rowRect.width - 20f, rowRect.height);
                
                // ã€ä¿®å¤ 6ã€‘å®‰å…¨è·å–å…µç§åç§°
                string labelText = kindDef.label != null ? kindDef.LabelCap.ToString() : kindDef.defName;
                
                if (isModified)
                {
                    GUI.color = Color.yellow;
                    Widgets.Label(new Rect(labelRect.x, labelRect.y + 6f, labelRect.width, 20f), labelText);
                    Widgets.DrawTextureFitted(new Rect(labelRect.x - 20f, labelRect.y + 8f, 16f, 16f), TexCache.ApplyTex, 0.8f);
                    GUI.color = Color.white;
                }
                else
                {
                    Widgets.Label(new Rect(labelRect.x, labelRect.y + 6f, labelRect.width, 20f), labelText);
                }
                // ... ä¿ç•™åç»­ç‚¹å‡»ä»£ç 

```

### ğŸ’¡ æ ¸å¿ƒæ”¹åŠ¨æ€»ç»“ï¼š

ç»è¿‡è¿™ä¸ªä¿®å¤ï¼ŒUnity å°†ä¸å†å› ä¸ºæ‹¿åˆ° `null` è€Œå½»åº•ç½¢å·¥ï¼Œåå°„å¼•èµ·çš„å·¨å¤§å¼€é”€å’Œå¡é¡¿ä¹Ÿå½»åº•æ¶ˆå¤±äº†ã€‚ç°åœ¨ä½ çš„åˆ—è¡¨æ»šåŠ¨ä¼šæå…¶ä¸æ»‘ï¼Œä¸”åœ¨ä»»ä½•ç•Œé¢ï¼ˆä¸»èœå•æˆ–æ¸¸æˆä¸­ï¼‰æ‰“å¼€éƒ½ä¸ä¼šå†çº¢å­—åˆ·å±ã€‚